# システム要件定義

## 1. 目的

本システムは、副業・個人事業における **顧客管理・案件管理・請求管理・入金管理・経費管理** を一元化し、月次・案件別の **利益を可視化** することを目的とする。

単なる記録ではなく、「誰から・どの案件で・いくら稼ぎ・いくら使い・いくら残ったか」を即座に把握できる状態を目指す。

---

## 2. 想定ユーザー

- 副業・個人開発・業務委託で収入を得ている個人
- 基本は 1 ユーザー運用（将来的な複数ユーザー拡張を考慮）

---

## 3. システム概要

- Web アプリケーション
- ログイン機能あり（どこからでも利用可能）
- データはユーザー単位で管理

---

## 4. 業務フロー

1. 顧客を登録
2. 顧客に紐づく案件を登録
3. 案件に対して請求書を作成
4. 請求書に対する入金を登録
5. 経費を登録（案件紐づけ可）
6. 月次で売上・経費・利益を自動集計

---

## 5. 機能要件

### 5.1 認証・ユーザー管理

- メールアドレス＋パスワードによるログイン
- ユーザー単位でのデータ分離
- セッション管理（JWT/Cookie）

---

### 5.2 顧客管理

**基本機能**

- 顧客登録・編集・削除

**管理項目**

- 顧客名（会社名/個人名）
- 担当者名
- メールアドレス
- 電話番号
- メモ

**顧客詳細画面**

- 紐づく案件一覧
- 売上サマリ（合計請求額・入金額）

---

### 5.3 案件管理

**基本機能**

- 案件登録・編集・削除

**管理項目**

- 案件名
- 顧客（必須）
- 契約形態（固定 / 時給 / 成果報酬）
- 契約金額
- 開始日 / 終了日
- ステータス（見込み / 進行中 / 完了 / 失注）

**案件詳細画面**

- 請求書一覧
- 案件別経費一覧
- 案件別利益（売上 - 経費）

---

### 5.4 請求書管理

**基本機能**

- 請求書作成・編集・削除

**請求書項目**

- 請求日（issued_at）
- 支払期限（due_at）
- 顧客（必須）
- 案件（必須）
- 明細（品目・数量・単価・金額）
- ステータス（DRAFT / SENT / PAID）

**機能**

- 請求書ごとの合計金額自動計算
- 明細から合計金額を算出（DB にも保存）
- ステータス管理
  - DRAFT: 下書き
  - SENT: 請求済（送付済）
  - PAID: 入金済（入金合計が請求額に達した時点で自動更新）

---

### 5.5 入金管理

**基本機能**

- 入金登録・編集・削除

**管理項目**

- 請求書（紐づけ必須）
- 入金日（paid_at）
- 入金金額
- 入金方法（銀行振込・クレジットカード・現金・その他）
- メモ

**特徴**

- 分割入金対応
- 入金額合計が請求額に達した場合、自動で請求書ステータスを「PAID」に更新
- 請求書に対する入金履歴を一覧表示

---

### 5.6 経費管理

**基本機能**

- 経費登録・編集・削除

**管理項目**

- 使用日（date）
- 金額
- カテゴリ（後述）
- 支払方法（クレジットカード・現金・振込・その他）
- メモ
- 案件（任意：紐づけ可能）

**特徴**

- 案件に紐づかない共通経費も管理可能
- 案件紐づけにより案件別利益計算が可能

**経費カテゴリ**

- ユーザーごとにカスタマイズ可能
- 例：通信費・交通費・ソフトウェア・広告費・外注費・その他

---

### 5.7 レポート・ダッシュボード

**月次サマリ**

- 売上（入金ベース / 請求ベース 切替可）
- 経費
- 利益（売上 - 経費）
- 未回収金額（請求額 - 入金額）

**グラフ表示**

- 月別 売上・経費・利益推移（折れ線グラフ）
- 経費カテゴリ別内訳（円グラフ）
- 案件別売上ランキング（棒グラフ）

**フィルタ機能**

- 期間指定（月・四半期・年）
- 案件別フィルタ
- 顧客別フィルタ

---

## 6. データ要件（主要エンティティ）

### 主要テーブル

- **users**: ユーザー情報
- **customers**: 顧客マスタ
- **projects**: 案件
- **invoices**: 請求書
- **invoice_items**: 請求明細
- **payments**: 入金
- **expenses**: 経費
- **expense_categories**: 経費カテゴリ

### 主なリレーション

```
users 1 : N customers
users 1 : N projects
users 1 : N invoices
users 1 : N expenses
users 1 : N expense_categories

customers 1 : N projects
projects 1 : N invoices
invoices 1 : N invoice_items
invoices 1 : N payments
projects 1 : N expenses (nullable)
expense_categories 1 : N expenses
```

---

## 7. 集計ルール

### 売上の定義

**入金ベース（キャッシュベース）**

- 入金日（paid_at）を基準に集計
- 実際にお金が入った時点で売上として計上

**請求ベース（発生ベース）**

- 請求日（issued_at）を基準に集計
- 請求書を発行した時点で売上として計上

### 利益計算

```
利益 = 売上 - 経費
```

### 未回収金額

```
未回収金額 = Σ(請求額) - Σ(入金額)
※ ステータスがSENT（請求済）かつ未入金の請求書が対象
```

### 案件別利益

```
案件別利益 = 案件の売上 - 案件に紐づく経費
```

---

## 8. 非機能要件

### セキュリティ

- パスワードのハッシュ化（bcrypt 等）
- 認可チェック（user_id スコープ）
  - すべての API で session.user.id を取得
  - すべてのデータ取得時に user_id で絞り込み
- ID の推測対策：外部公開は UUID 使用

### パフォーマンス

- ページネーション実装（一覧画面）
- インデックス設定（user_id, customer_id, project_id 等）
- N+1 問題の回避（Prisma の include 活用）

### 可用性

- DB バックアップ（自動スナップショット）
- エラーログ記録
- 監査ログ（任意：invoice/payment/expense の更新履歴）

### 拡張性

- 将来的な複数ユーザー対応を考慮した設計
- API 設計は RESTful
- レイヤードアーキテクチャによる変更容易性

---

## 9. MVP スコープ（最小限の実装）

### Phase 1: 基盤構築

1. ✅ 認証・ユーザースコープ
2. ✅ 顧客 CRUD

### Phase 2: コア機能

3. ✅ 案件 CRUD（顧客紐づけ）
4. ✅ 請求書 CRUD（明細・合計算出）
5. ✅ 入金登録（分割・自動入金済）

### Phase 3: 経費・レポート

6. ✅ 経費 CRUD（案件紐づけ任意）
7. ✅ 月次ダッシュボード（売上/経費/利益/未回収 + グラフ）

### Phase 4: 改善

8. 🔲 請求書 PDF 出力
9. 🔲 CSV エクスポート
10. 🔲 支払期限アラート
11. 🔲 メール通知

---

## 10. 将来拡張

### 中期拡張

- 請求書テンプレート（カスタマイズ可能）
- 定期請求（月次自動発行）
- 見積書管理
- 領収書管理

### 長期拡張

- 税務・確定申告向け機能
  - 青色申告対応
  - 消費税計算
  - e-Tax 連携
- 複数ユーザー・権限管理
  - チーム機能
  - アクセス権限設定
- 外部連携
  - 銀行 API 連携（入金自動取込）
  - 会計ソフト連携（freee/MF クラウド）
  - Slack 通知

---

## 11. 制約・前提条件

### 通貨

- 日本円（JPY）のみ対応
- 金額は整数で管理（最小通貨単位：円）
- float 型は使用禁止（精度問題回避）

### タイムゾーン

- すべての日時は UTC で保存
- 表示時にユーザーのタイムゾーン（JST）に変換

### 消費税

- MVP 段階では税抜き金額のみ管理
- 将来的に税率・税込み金額に対応

### データ保持

- 論理削除（deleted_at）を推奨
- 物理削除は運用上必要な場合のみ

---

## 12. 用語集

| 用語   | 説明                                       |
| ------ | ------------------------------------------ |
| 顧客   | 請求先となる企業・個人                     |
| 案件   | 顧客に対する業務契約の単位                 |
| 請求書 | 案件に対する請求内容を記載したドキュメント |
| 明細   | 請求書に含まれる品目・数量・単価・金額     |
| 入金   | 請求書に対する支払い                       |
| 経費   | 業務遂行に必要な費用                       |
| 売上   | 入金または請求の合計額                     |
| 利益   | 売上から経費を差し引いた金額               |
| 未回収 | 請求済みだが未入金の金額                   |
